name: Playwright PR Comment

on:
  workflow_run:
    workflows: ["Playwright Tests"]
    types:
      - completed

jobs:
  comment:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    
    steps:
    - name: Download artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: ${{ github.event.workflow_run.id }},
          });
          
          const matchArtifact = artifacts.data.artifacts.filter((artifact) => {
            return artifact.name == "playwright-report-merged"
          })[0];
          
          if (matchArtifact) {
            const download = await github.rest.actions.downloadArtifact({
              owner: context.repo.owner,
              repo: context.repo.repo,
              artifact_id: matchArtifact.id,
              archive_format: 'zip',
            });
            
            const fs = require('fs');
            fs.writeFileSync('${{ github.workspace }}/playwright-report.zip', Buffer.from(download.data));
          }
    
    - name: Extract report
      run: |
        if [ -f playwright-report.zip ]; then
          unzip playwright-report.zip
          ls -la
        fi
    
    - name: Read test results
      id: test-results
      run: |
        if [ -f report.json ]; then
          echo "results_exist=true" >> $GITHUB_OUTPUT
          
          # Extract basic stats from the JSON report
          TOTAL=$(jq '.stats.total' report.json)
          PASSED=$(jq '.stats.passed' report.json)
          FAILED=$(jq '.stats.failed' report.json)
          SKIPPED=$(jq '.stats.skipped' report.json)
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        else
          echo "results_exist=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Comment PR
      if: steps.test-results.outputs.results_exist == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequests } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: '${{ github.event.workflow_run.head_sha }}',
          });
          
          if (pullRequests.length > 0) {
            const pr = pullRequests[0];
            
            const total = '${{ steps.test-results.outputs.total }}';
            const passed = '${{ steps.test-results.outputs.passed }}';
            const failed = '${{ steps.test-results.outputs.failed }}';
            const skipped = '${{ steps.test-results.outputs.skipped }}';
            
            const status = failed > 0 ? '❌' : '✅';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}`;
            
            const body = `## ${status} Playwright Test Results
            
            | Status | Count |
            |--------|-------|
            | ✅ Passed | ${passed} |
            | ❌ Failed | ${failed} |
            | ⏭️ Skipped | ${skipped} |
            | **Total** | **${total}** |
            
            [View full report](${runUrl})
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: body
            });
          }